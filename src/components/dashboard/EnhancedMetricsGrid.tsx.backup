"use client";

import React from "react";
import Badge from "@/components/tailadmin/ui/badge/Badge";
import { ArrowDownIcon, ArrowUpIcon } from "@/icons";
import { Star, MessageCircle, Award, AlertTriangle, ThumbsUp, TrendingUp, TrendingDown, BarChart3, Sparkles, ChevronRight, HelpCircle, X } from "lucide-react";
import { MetricsSummary } from "@/data/dataService";
import { useEffect, useState, useRef } from "react";
import AnimatedNumber from "@/components/AnimatedNumber";

interface EnhancedMetricsGridProps {
  metrics: MetricsSummary;
  previousMetrics?: MetricsSummary | null;
  showComparison?: boolean;
}

export default function EnhancedMetricsGrid({ metrics, previousMetrics, showComparison }: EnhancedMetricsGridProps) {
  const [currentMetrics, setCurrentMetrics] = useState(metrics);
  const [oldMetrics, setOldMetrics] = useState(metrics);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const prevMetricsRef = useRef(metrics);
  
  useEffect(() => {
    // Detect when metrics change (time period switch)
    if (prevMetricsRef.current.total !== metrics.total || 
        prevMetricsRef.current.avg_rating !== metrics.avg_rating) {
      
      // Store old metrics for exit animation
      setOldMetrics(currentMetrics);
      setIsTransitioning(true);
      
      // After brief delay, update to new metrics (for entrance animation)
      setTimeout(() => {
        setCurrentMetrics(metrics);
      }, 50);
      
      // Clean up transition state after animations complete
      setTimeout(() => {
        setIsTransitioning(false);
      }, 800);
    }
    prevMetricsRef.current = metrics;
  }, [metrics, currentMetrics]);
  
  // Calculate key metrics
  const fiveStarRate = (metrics.star_5 / metrics.total) * 100;
  const prevFiveStarRate = previousMetrics ? (previousMetrics.star_5 / previousMetrics.total) * 100 : null;
  
  const problemReviews = metrics.star_1 + metrics.star_2;
  const prevProblemReviews = previousMetrics ? previousMetrics.star_1 + previousMetrics.star_2 : null;
  
  const positiveReviews = metrics.star_4 + metrics.star_5;
  const positiveRate = (positiveReviews / metrics.total) * 100;
  
  // Helper to calculate percentage change
  const getChange = (current: number, previous: number | null) => {
    if (!showComparison || previous === null || previous === 0) return null;
    const change = ((current - previous) / previous) * 100;
    return {
      value: Math.abs(change).toFixed(2),
      isPositive: change >= 0,
      isNegative: change < 0,
      raw: change
    };
  };

  const satisfactionChange = getChange(fiveStarRate, prevFiveStarRate);
  const totalChange = getChange(metrics.total, previousMetrics?.total || null);
  const ratingChange = getChange(metrics.avg_rating, previousMetrics?.avg_rating || null);
  const problemChange = getChange(problemReviews, prevProblemReviews);

  // UNIFIED TIER SYSTEM - Customer Satisfaction (5-star rate %)
  const getSatisfactionStatus = (rate: number) => {
    if (rate >= 85) return { 
      status: "Elite", 
      color: "purple",
      icon: Sparkles,
      description: "Top 10% performance",
      message: "World-class service!"
    };
    if (rate >= 70) return { 
      status: "Excellent", 
      color: "success",
      icon: Award,
      description: "Strong performance",
      message: "Keep up the great work!"
    };
    if (rate >= 55) return { 
      status: "Good", 
      color: "info",
      icon: ThumbsUp,
      description: "Solid performance",
      message: "On the right track"
    };
    return { 
      status: "Needs Attention", 
      color: "error",
      icon: AlertTriangle,
      description: "Below target",
      message: "Immediate focus needed"
    };
  };

  // UNIFIED TIER SYSTEM - Average Rating (out of 5.0)
  const getRatingStatus = (rating: number) => {
    if (rating >= 4.8) return { 
      status: "Elite", 
      color: "purple",
      icon: Sparkles,
      description: "Top 10% performance"
    };
    if (rating >= 4.5) return { 
      status: "Excellent", 
      color: "success",
      icon: Award,
      description: "Strong performance"
    };
    if (rating >= 4.0) return { 
      status: "Good", 
      color: "info",
      icon: ThumbsUp,
      description: "Solid performance"
    };
    return { 
      status: "Needs Attention", 
      color: "error",
      icon: AlertTriangle,
      description: "Below target"
    };
  };

  // UNIFIED TIER SYSTEM - Total Reviews (volume trend %)
  const getVolumeStatus = (change: any) => {
    if (!change) return null;
    const percentChange = parseFloat(change.value);
    
    if (change.isPositive && percentChange >= 25) return {
      status: "Elite",
      color: "purple",
      icon: Sparkles,
      description: "Exceptional growth"
    };
    if (change.isPositive && percentChange >= 10) return {
      status: "Excellent",
      color: "success",
      icon: Award,
      description: "Strong growth"
    };
    if (percentChange > -10) return {
      status: "Good",
      color: "info",
      icon: ThumbsUp,
      description: "Stable volume"
    };
    return {
      status: "Needs Attention",
      color: "error",
      icon: AlertTriangle,
      description: "Declining volume"
    };
  };

  // UNIFIED TIER SYSTEM - Problem Reviews (1-2 star %)
  const getProblemStatus = (problemRate: number) => {
    if (problemRate < 5) return {
      status: "Elite",
      color: "purple",
      icon: Sparkles,
      description: "Minimal issues"
    };
    if (problemRate < 10) return {
      status: "Excellent",
      color: "success",
      icon: Award,
      description: "Low problem rate"
    };
    if (problemRate < 15) return {
      status: "Good",
      color: "info",
      icon: ThumbsUp,
      description: "Acceptable rate"
    };
    return {
      status: "Needs Attention",
      color: "error",
      icon: AlertTriangle,
      description: "High problem rate"
    };
  };

  const satisfactionStatus = getSatisfactionStatus(fiveStarRate);
  const ratingStatus = getRatingStatus(metrics.avg_rating);
  const volumeStatus = getVolumeStatus(totalChange);
  const problemRate = (problemReviews / metrics.total) * 100;
  const problemStatus = getProblemStatus(problemRate);

  // Check for elite status for special styling
  const isSatisfactionElite = satisfactionStatus.status === "Elite";
  const isRatingElite = ratingStatus.status === "Elite";
  const isVolumeElite = volumeStatus?.status === "Elite";
  
  // Mini sparkline component for trends
  const TrendSparkline = ({ change }: { change: any }) => {
    if (!change) return null;
    const isUp = change.isPositive;
    const points = isUp ? "M0,20 L10,15 L20,10 L30,8 L40,5" : "M0,5 L10,8 L20,10 L30,15 L40,20";
    
    return (
      <svg width="40" height="20" className="opacity-30 ml-2" style={{ display: 'inline-block', verticalAlign: 'middle' }}>
        <path 
          d={points} 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        />
      </svg>
    );
  };
  
  return (
    <div className="space-y-6">
      {/* Help Button - Performance Tiers Guide */}
      <div className="flex justify-end">
        <button
          onClick={() => setShowHelp(true)}
          className="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-[#0066cc] bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg transition-all hover:shadow-md"
          aria-label="View performance tier guide"
        >
          <HelpCircle className="w-4 h-4" strokeWidth={2.5} />
          <span>Performance Tiers Guide</span>
        </button>
      </div>

      {/* Help Modal */}
      {showHelp && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setShowHelp(false)}>
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-auto" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="sticky top-0 bg-gradient-to-r from-[#0066cc] to-blue-600 text-white p-6 rounded-t-2xl">
              <div className="flex items-start justify-between">
                <div>
                  <h2 className="text-2xl font-black mb-2">Performance Tier System</h2>
                  <p className="text-blue-100 text-sm">Understanding your metrics and rankings</p>
                </div>
                <button onClick={() => setShowHelp(false)} className="text-white/80 hover:text-white hover:bg-white/20 rounded-lg p-2 transition-all">
                  <X className="w-6 h-6" strokeWidth={2.5} />
                </button>
              </div>
            </div>

            {/* Content */}
            <div className="p-6 space-y-8">
              {/* Tier Overview */}
              <div className="space-y-4">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white">Performance Tiers</h3>
                <p className="text-sm text-gray-600 dark:text-gray-300">All metrics use a consistent 4-tier ranking system:</p>
                
                <div className="grid gap-3">
                  {/* Elite */}
                  <div className="flex items-start gap-4 p-4 bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 border-2 border-purple-200 dark:border-purple-700 rounded-xl">
                    <div className="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg">
                      <Sparkles className="w-6 h-6 text-white" strokeWidth={2.5} />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-black text-lg text-purple-700 dark:text-purple-300">üåü Elite</span>
                        <span className="text-xs px-2 py-1 bg-purple-600 text-white rounded-lg font-semibold">Top 10%</span>
                      </div>
                      <p className="text-sm text-gray-700 dark:text-gray-300">World-class performance. You're in the top tier!</p>
                    </div>
                  </div>

                  {/* Excellent */}
                  <div className="flex items-start gap-4 p-4 bg-gradient-to-r from-green-50 to-emerald-100 dark:from-green-900/20 dark:to-emerald-800/20 border-2 border-green-200 dark:border-green-700 rounded-xl">
                    <div className="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg">
                      <Award className="w-6 h-6 text-white" strokeWidth={2.5} />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-black text-lg text-green-700 dark:text-green-300">üèÜ Excellent</span>
                        <span className="text-xs px-2 py-1 bg-green-600 text-white rounded-lg font-semibold">Strong</span>
                      </div>
                      <p className="text-sm text-gray-700 dark:text-gray-300">Strong performance with great results.</p>
                    </div>
                  </div>

                  {/* Good */}
                  <div className="flex items-start gap-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 border-2 border-blue-200 dark:border-blue-700 rounded-xl">
                    <div className="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg">
                      <ThumbsUp className="w-6 h-6 text-white" strokeWidth={2.5} />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-black text-lg text-blue-700 dark:text-blue-300">üëç Good</span>
                        <span className="text-xs px-2 py-1 bg-blue-600 text-white rounded-lg font-semibold">Solid</span>
                      </div>
                      <p className="text-sm text-gray-700 dark:text-gray-300">Solid performance, on the right track.</p>
                    </div>
                  </div>

                  {/* Needs Attention */}
                  <div className="flex items-start gap-4 p-4 bg-gradient-to-r from-red-50 to-orange-100 dark:from-red-900/20 dark:to-orange-800/20 border-2 border-red-200 dark:border-red-700 rounded-xl">
                    <div className="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg">
                      <AlertTriangle className="w-6 h-6 text-white" strokeWidth={2.5} />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-black text-lg text-red-700 dark:text-red-300">‚ö†Ô∏è Needs Attention</span>
                        <span className="text-xs px-2 py-1 bg-red-600 text-white rounded-lg font-semibold">Action Required</span>
                      </div>
                      <p className="text-sm text-gray-700 dark:text-gray-300">Below target, requires immediate focus.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Metric Thresholds */}
              <div className="space-y-4">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white">Metric Thresholds</h3>
                
                <div className="grid gap-4">
                  {/* Customer Satisfaction */}
                  <div className="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h4 className="font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                      <ThumbsUp className="w-5 h-5 text-green-600" />
                      Customer Satisfaction (5-Star Rate %)
                    </h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div><span className="font-semibold text-purple-700 dark:text-purple-400">Elite:</span> ‚â• 85%</div>
                      <div><span className="font-semibold text-green-700 dark:text-green-400">Excellent:</span> 70-84%</div>
                      <div><span className="font-semibold text-blue-700 dark:text-blue-400">Good:</span> 55-69%</div>
                      <div><span className="font-semibold text-red-700 dark:text-red-400">Needs Attention:</span> &lt; 55%</div>
                    </div>
                  </div>

                  {/* Average Rating */}
                  <div className="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h4 className="font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                      <Star className="w-5 h-5 text-amber-500 fill-amber-500" />
                      Average Rating (out of 5.0)
                    </h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div><span className="font-semibold text-purple-700 dark:text-purple-400">Elite:</span> ‚â• 4.8</div>
                      <div><span className="font-semibold text-green-700 dark:text-green-400">Excellent:</span> 4.5-4.79</div>
                      <div><span className="font-semibold text-blue-700 dark:text-blue-400">Good:</span> 4.0-4.49</div>
                      <div><span className="font-semibold text-red-700 dark:text-red-400">Needs Attention:</span> &lt; 4.0</div>
                    </div>
                  </div>

                  {/* Total Reviews */}
                  <div className="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h4 className="font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                      <MessageCircle className="w-5 h-5 text-blue-600" />
                      Total Reviews (Growth Trend %)
                    </h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div><span className="font-semibold text-purple-700 dark:text-purple-400">Elite:</span> +25% or more</div>
                      <div><span className="font-semibold text-green-700 dark:text-green-400">Excellent:</span> +10% to +24%</div>
                      <div><span className="font-semibold text-blue-700 dark:text-blue-400">Good:</span> -10% to +9%</div>
                      <div><span className="font-semibold text-red-700 dark:text-red-400">Needs Attention:</span> -10% or worse</div>
                    </div>
                  </div>

                  {/* Problem Reviews */}
                  <div className="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h4 className="font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                      <AlertTriangle className="w-5 h-5 text-red-600" />
                      Problem Reviews (1-2 Star %)
                    </h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div><span className="font-semibold text-purple-700 dark:text-purple-400">Elite:</span> &lt; 5%</div>
                      <div><span className="font-semibold text-green-700 dark:text-green-400">Excellent:</span> 5-9.9%</div>
                      <div><span className="font-semibold text-blue-700 dark:text-blue-400">Good:</span> 10-14.9%</div>
                      <div><span className="font-semibold text-red-700 dark:text-red-400">Needs Attention:</span> ‚â• 15%</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="pt-4 border-t border-gray-200 dark:border-gray-700">
                <p className="text-xs text-gray-500 dark:text-gray-400 text-center">
                  These thresholds are based on industry benchmarks and best practices for customer service excellence.
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Container with relative positioning for overlay */}
      <div className="relative min-h-[200px]">
        
        {/* OLD CARDS - Exiting to left with stagger */}
        {isTransitioning && (
          <div className="grid grid-cols-2 gap-3 sm:gap-4 lg:grid-cols-4 md:gap-6 absolute inset-0 w-full pointer-events-none">
            {renderCards(oldMetrics, true)}
          </div>
        )}
        
        {/* NEW CARDS - Entering from right with stagger */}
        <div className="grid grid-cols-2 gap-3 sm:gap-4 lg:grid-cols-4 md:gap-6">
          {renderCards(currentMetrics, false)}
        </div>
      </div>
    </div>
  );
  
  function renderCards(metricsData: MetricsSummary, isExiting: boolean) {
    const fiveStarRate = (metricsData.star_5 / metricsData.total) * 100;
    const problemReviews = metricsData.star_1 + metricsData.star_2;
    const positiveReviews = metricsData.star_4 + metricsData.star_5;
    
    const prevFiveStarRate = previousMetrics ? (previousMetrics.star_5 / previousMetrics.total) * 100 : null;
    const prevProblemReviews = previousMetrics ? previousMetrics.star_1 + previousMetrics.star_2 : null;
    
    const satisfactionChange = getChange(fiveStarRate, prevFiveStarRate);
    const totalChange = getChange(metricsData.total, previousMetrics?.total || null);
    const ratingChange = getChange(metricsData.avg_rating, previousMetrics?.avg_rating || null);
    const problemChange = getChange(problemReviews, prevProblemReviews);
    
    const satisfactionStatus = getSatisfactionStatus(fiveStarRate);
    const ratingStatus = getRatingStatus(metricsData.avg_rating);
    const volumeStatus = getVolumeStatus(totalChange);
    const problemRate = (problemReviews / metricsData.total) * 100;
    const problemStatus = getProblemStatus(problemRate);
    
    const isSatisfactionElite = satisfactionStatus.status === "Elite";
    const isRatingElite = ratingStatus.status === "Elite";
    const isVolumeElite = volumeStatus?.status === "Elite";
    
    // Animation classes with staggered delays
    const getCardAnimation = (index: number) => {
      const delay = index * 60; // 60ms stagger between cards
      if (isExiting) {
        return `animate-slide-out-left opacity-100`;
      } else if (isTransitioning) {
        return `animate-slide-in-right opacity-0`;
      }
      return 'opacity-100';
    };
    
    const getCardStyle = (index: number) => {
      const delay = index * 60;
      return {
        animationDelay: `${delay}ms`
      };
    };
    
    return (
      <>
        {/* 1. CUSTOMER SATISFACTION */}
        <div 
          className={`group relative flex flex-col rounded-xl sm:rounded-2xl border-2 p-5 sm:p-7 transition-all cursor-pointer overflow-hidden
            ${getCardAnimation(0)}
            hover:scale-[1.03] hover:-translate-y-1 active:scale-[0.99]
            ${isExcellent 
              ? 'border-green-400/80 bg-gradient-to-br from-green-100/80 via-white to-emerald-100/60 dark:border-green-500/70 dark:from-green-900/50 dark:via-gray-800 dark:to-emerald-900/40 shadow-2xl shadow-green-300/80 dark:shadow-green-700/60' 
              : 'border-gray-300/70 bg-white dark:border-gray-600/60 dark:bg-gray-800/70 hover:border-green-300/70 dark:hover:border-green-600/60 hover:shadow-xl shadow-md'
          }`}
          style={getCardStyle(0)}
          role="button"
          tabIndex={0}
          aria-label={`Customer Satisfaction: ${fiveStarRate.toFixed(1)}% - ${healthStatus.status}`}
        >
          {/* Premium gradient overlay */}
          <div className="absolute inset-0 bg-gradient-to-br from-white/80 via-white/30 to-transparent pointer-events-none" />
          
          {/* Refined accent bar with gradient and glow */}
          <div className={`absolute top-0 left-0 right-0 h-1.5 sm:h-2 transition-all duration-700 ${
            isExcellent 
              ? 'bg-gradient-to-r from-emerald-500 via-green-500 to-emerald-500 shadow-lg shadow-green-500/60' 
              : 'bg-gradient-to-r from-green-300 via-green-400 to-green-300 opacity-0 group-hover:opacity-100'
          }`} />

          {/* Top Section - Icon + Badge */}
          <div className="flex items-start justify-between mb-4 sm:mb-5 relative z-10">
            <div className={`flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 rounded-2xl transition-all duration-700 ${
              isSatisfactionSurging ? 'animate-bounce-subtle' : ''
            } ${
              isExcellent 
                ? 'bg-gradient-to-br from-green-500 via-green-600 to-emerald-600 shadow-xl shadow-green-400/70 dark:shadow-green-500/50 scale-105' 
                : 'bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-800/40 dark:to-emerald-800/30 group-hover:scale-105 group-hover:shadow-md'
            }`}>
              <ThumbsUp className={`size-6 sm:size-9 transition-all duration-700 ${
                isExcellent 
                  ? 'text-white drop-shadow-lg' 
                  : 'text-green-700 dark:text-green-300'
              }`} strokeWidth={2.5} />
            </div>
            <div className="flex flex-col items-end gap-1.5">
              <Badge color={healthStatus.color as any}>
                <span className="text-xs sm:text-sm font-bold tracking-wide px-1">{healthStatus.status}</span>
              </Badge>
              {isSatisfactionSurging && (
                <div className="flex items-center gap-1 bg-green-600/20 dark:bg-green-500/20 px-2.5 py-1 rounded-full border border-green-400/50 dark:border-green-500/40 shadow-sm">
                  <Sparkles className="size-3.5 text-green-700 dark:text-green-300" />
                  <span className="text-[10px] sm:text-xs font-bold text-green-700 dark:text-green-300 uppercase tracking-wider">
                    Surge
                  </span>
                </div>
              )}
            </div>
          </div>

          {/* Middle Section - Label + Value */}
          <div className="flex-1 relative z-10">
            <span className="block text-xs sm:text-sm font-bold text-gray-600 dark:text-gray-300 mb-2 sm:mb-3 uppercase tracking-wider">
              Customer Satisfaction
            </span>
            <div className="flex items-baseline gap-2 mb-2">
              <h4 className={`font-black text-3xl sm:text-5xl transition-all duration-700 tabular-nums leading-none ${
                isExcellent 
                  ? 'text-transparent bg-clip-text bg-gradient-to-r from-green-600 via-emerald-600 to-green-600 dark:from-green-400 dark:via-emerald-400 dark:to-green-400 drop-shadow-sm' 
                  : 'text-gray-900 dark:text-white'
              }`}>
                <AnimatedNumber value={fiveStarRate} decimals={1} duration={800} />
                <span className="text-2xl sm:text-3xl ml-0.5">%</span>
              </h4>
              {satisfactionChange && <TrendSparkline change={satisfactionChange} />}
            </div>
            <div className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
              <span className={`text-xs sm:text-sm ${
                isExcellent ? 'text-green-700 dark:text-green-300 font-bold' : 'text-gray-600 dark:text-gray-300 font-semibold'
              }`}>
                5-star rate
              </span>
              {isExcellent && (
                <span className="text-xs text-green-600 dark:text-green-400 italic font-medium">
                  {healthStatus.message}
                </span>
              )}
            </div>
          </div>

          {/* Bottom Section - Trend with enhanced visual */}
          {satisfactionChange && (
            <div className="flex items-center justify-between gap-2 mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-100/80 dark:border-gray-700/50 relative z-10">
              <div className="flex items-center gap-1.5">
                <Badge color={satisfactionChange.isPositive ? "success" : "error"}>
                  <span className="text-[10px] sm:text-xs flex items-center gap-1 font-semibold shadow-sm">
                    {satisfactionChange.isPositive ? <ArrowUpIcon className="size-3" /> : <ArrowDownIcon className="size-3" />}
                    {satisfactionChange.value}%
                  </span>
                </Badge>
                <span className="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400">vs last period</span>
              </div>
              <ChevronRight className="size-4 text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
            </div>
          )}
          
          {/* Hover glow effect */}
          <div className="absolute inset-0 rounded-xl sm:rounded-2xl bg-gradient-to-br from-green-400/0 via-green-400/0 to-green-400/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none" />
        </div>

        {/* 2. TOTAL REVIEWS - Volume Indicator */}
        <div 
          className={`group relative flex flex-col rounded-xl sm:rounded-2xl border-2 p-5 sm:p-7 transition-all cursor-pointer overflow-hidden
            ${getCardAnimation(1)}
            hover:scale-[1.03] hover:-translate-y-1 active:scale-[0.99]
            ${isReviewsOnFire
              ? 'border-blue-400/80 bg-gradient-to-br from-blue-100/80 via-white to-orange-100/50 dark:border-blue-500/70 dark:from-blue-900/50 dark:via-gray-800 dark:to-orange-900/30 shadow-2xl shadow-blue-300/80 dark:shadow-blue-700/60'
              : 'border-gray-300/70 bg-white dark:border-gray-600/60 dark:bg-gray-800/70 hover:border-blue-300/70 dark:hover:border-blue-600/60 hover:shadow-xl shadow-md'
          }`}
          style={getCardStyle(1)}
          role="button"
          tabIndex={0}
          aria-label={`Total Reviews: ${metricsData.total.toLocaleString()}`}
        >
          {/* Premium gradient overlay */}
          <div className="absolute inset-0 bg-gradient-to-br from-white/80 via-white/30 to-transparent pointer-events-none" />
          
          {/* Refined accent bar */}
          <div className={`absolute top-0 left-0 right-0 h-1.5 sm:h-2 transition-all duration-700 ${
            isReviewsOnFire 
              ? 'bg-gradient-to-r from-orange-500 via-red-500 to-orange-500 shadow-lg shadow-orange-500/60' 
              : 'bg-gradient-to-r from-blue-300 via-blue-400 to-blue-300 opacity-0 group-hover:opacity-100'
          }`} />

          {/* Top Section */}
          <div className="flex items-start justify-between mb-4 sm:mb-5 relative z-10">
            <div className={`flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 rounded-2xl transition-all duration-500 ${
              isReviewsOnFire 
                ? 'bg-gradient-to-br from-blue-500 via-blue-600 to-blue-600 animate-bounce-subtle shadow-xl shadow-blue-400/70 dark:shadow-blue-500/50 scale-105' 
                : 'bg-gradient-to-br from-blue-100 to-blue-100 dark:from-blue-800/40 dark:to-blue-800/30 group-hover:scale-105 group-hover:shadow-md'
            }`}>
              <MessageCircle className={`size-6 sm:size-9 transition-colors duration-500 ${
                isReviewsOnFire ? 'text-white drop-shadow-lg' : 'text-blue-700 dark:text-blue-300'
              }`} strokeWidth={2.5} />
            </div>
            {isReviewsOnFire && (
              <div className="text-4xl sm:text-5xl animate-pulse drop-shadow-lg" title="On fire! Review volume increased 20%+ compared to last period!">
                üî•
              </div>
            )}
          </div>

          {/* Middle Section */}
          <div className="flex-1 relative z-10">
            <span className="block text-xs sm:text-sm font-bold text-gray-600 dark:text-gray-300 mb-2 sm:mb-3 uppercase tracking-wider">
              Total Reviews
            </span>
            <div className="flex items-baseline gap-2 mb-2">
              <h4 className={`font-black text-3xl sm:text-5xl transition-all duration-500 tabular-nums leading-none ${
                isReviewsOnFire 
                  ? 'text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-blue-700 to-blue-600 dark:from-blue-400 dark:via-blue-500 dark:to-blue-400 drop-shadow-sm' 
                  : 'text-gray-900 dark:text-white'
              }`}>
                <AnimatedNumber value={metrics.total} decimals={0} duration={800} />
              </h4>
              {totalChange && <TrendSparkline change={totalChange} />}
            </div>
            <div className="flex items-center gap-2">
              <span className={`text-xs sm:text-sm ${
                isReviewsOnFire ? 'text-blue-700 dark:text-blue-300 font-bold' : 'text-gray-600 dark:text-gray-300 font-semibold'
              }`}>
                all sources
              </span>
            </div>
          </div>

          {/* Bottom Section */}
          {totalChange && (
            <div className="flex items-center justify-between gap-2 mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-100/80 dark:border-gray-700/50 relative z-10">
              <div className="flex items-center gap-1.5">
                <Badge color={totalChange.isPositive ? "success" : "error"}>
                  <span className="text-[10px] sm:text-xs flex items-center gap-1 font-semibold shadow-sm">
                    {totalChange.isPositive ? <ArrowUpIcon className="size-3" /> : <ArrowDownIcon className="size-3" />}
                    {totalChange.value}%
                  </span>
                </Badge>
                <span className="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400">vs last period</span>
              </div>
              <ChevronRight className="size-4 text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
            </div>
          )}
          
          {/* Hover glow effect */}
          <div className="absolute inset-0 rounded-xl sm:rounded-2xl bg-gradient-to-br from-blue-400/0 via-blue-400/0 to-blue-400/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none" />
        </div>

        {/* 3. AVERAGE RATING - Quality Metric */}
        <div 
          className={`group relative flex flex-col rounded-xl sm:rounded-2xl border-2 p-5 sm:p-7 transition-all cursor-pointer overflow-hidden
            ${getCardAnimation(2)}
            hover:scale-[1.03] hover:-translate-y-1 active:scale-[0.99]
            ${metricsData.avg_rating >= 4.8
              ? 'border-amber-400/80 bg-gradient-to-br from-amber-100/80 via-white to-yellow-100/60 dark:border-amber-500/70 dark:from-amber-900/50 dark:via-gray-800 dark:to-yellow-900/40 shadow-2xl shadow-amber-300/80 dark:shadow-amber-700/60'
              : 'border-gray-300/70 bg-white dark:border-gray-600/60 dark:bg-gray-800/70 hover:border-amber-300/70 dark:hover:border-amber-600/60 hover:shadow-xl shadow-md'
          }`}
          style={getCardStyle(2)}
          role="button"
          tabIndex={0}
          aria-label={`Average Rating: ${metricsData.avg_rating.toFixed(2)} out of 5`}
        >
          {/* Premium gradient overlay */}
          <div className="absolute inset-0 bg-gradient-to-br from-white/80 via-white/30 to-transparent pointer-events-none" />
          
          {/* Refined accent bar */}
          <div className={`absolute top-0 left-0 right-0 h-1.5 sm:h-2 transition-all duration-700 ${
            metrics.avg_rating >= 4.8 
              ? 'bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 shadow-lg shadow-amber-500/60' 
              : 'bg-gradient-to-r from-amber-300 via-amber-400 to-amber-300 opacity-0 group-hover:opacity-100'
          }`} />

          {/* Top Section */}
          <div className="flex items-start justify-between mb-4 sm:mb-5 relative z-10">
            <div className={`flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 rounded-2xl transition-all duration-500 ${
              metrics.avg_rating >= 4.8 
                ? 'bg-gradient-to-br from-amber-500 via-amber-600 to-yellow-600 shadow-xl shadow-amber-400/70 dark:shadow-amber-500/50 scale-105' 
                : 'bg-gradient-to-br from-amber-100 to-amber-100 dark:from-amber-800/40 dark:to-amber-800/30 group-hover:scale-105 group-hover:shadow-md'
            }`}>
              <Star className={`size-6 sm:size-9 transition-all duration-500 ${
                metrics.avg_rating >= 4.8 
                  ? 'text-white fill-white drop-shadow-lg' 
                  : 'text-amber-700 dark:text-amber-300 fill-amber-700 dark:fill-amber-300'
              }`} strokeWidth={2.5} />
            </div>
            {metrics.avg_rating >= 4.8 && (
              <div className="flex items-center gap-1 bg-amber-600/20 dark:bg-amber-500/20 px-2.5 py-1 rounded-full border border-amber-400/50 dark:border-amber-500/40 shadow-sm">
                <Sparkles className="size-3.5 text-amber-700 dark:text-amber-300" />
                <span className="text-[10px] sm:text-xs font-bold text-amber-700 dark:text-amber-300 uppercase tracking-wider">
                  Elite
                </span>
              </div>
            )}
          </div>

          {/* Middle Section */}
          <div className="flex-1 relative z-10">
            <span className="block text-xs sm:text-sm font-bold text-gray-600 dark:text-gray-300 mb-2 sm:mb-3 uppercase tracking-wider">
              Average Rating
            </span>
            <div className="flex items-baseline gap-2 mb-2">
              <h4 className={`font-black text-3xl sm:text-5xl transition-all duration-500 tabular-nums leading-none ${
                metrics.avg_rating >= 4.8 
                  ? 'text-transparent bg-clip-text bg-gradient-to-r from-amber-600 via-yellow-600 to-amber-600 dark:from-amber-400 dark:via-yellow-400 dark:to-amber-400 drop-shadow-sm' 
                  : 'text-gray-900 dark:text-white'
              }`}>
                <AnimatedNumber value={metrics.avg_rating} decimals={2} duration={800} />
              </h4>
              <Star className={`size-6 sm:size-7 ${
                metrics.avg_rating >= 4.8 ? 'text-amber-600 fill-amber-600 dark:text-amber-400 dark:fill-amber-400' : 'text-amber-500 fill-amber-500 dark:text-amber-400 dark:fill-amber-400'
              }`} />
              {ratingChange && <TrendSparkline change={ratingChange} />}
            </div>
            <div className="flex items-center gap-2">
              <span className={`text-xs sm:text-sm ${
                metrics.avg_rating >= 4.8 ? 'text-amber-700 dark:text-amber-300 font-bold' : 'text-gray-600 dark:text-gray-300 font-semibold'
              }`}>
                out of 5.0
              </span>
            </div>
          </div>

          {/* Bottom Section */}
          {ratingChange && (
            <div className="flex items-center justify-between gap-2 mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-100/80 dark:border-gray-700/50 relative z-10">
              <div className="flex items-center gap-1.5">
                <Badge color={ratingChange.isPositive ? "success" : "error"}>
                  <span className="text-[10px] sm:text-xs flex items-center gap-1 font-semibold shadow-sm">
                    {ratingChange.isPositive ? <ArrowUpIcon className="size-3" /> : <ArrowDownIcon className="size-3" />}
                    {ratingChange.value}%
                  </span>
                </Badge>
                <span className="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400">vs last period</span>
              </div>
              <ChevronRight className="size-4 text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
            </div>
          )}
          
          {/* Hover glow effect */}
          <div className="absolute inset-0 rounded-xl sm:rounded-2xl bg-gradient-to-br from-amber-400/0 via-amber-400/0 to-amber-400/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none" />
        </div>


        {/* 4. PROBLEM REVIEWS - Critical Alert Metric */}
        <div 
          className={`group relative flex flex-col rounded-xl sm:rounded-2xl border-2 p-5 sm:p-7 transition-all cursor-pointer overflow-hidden
            ${getCardAnimation(3)}
            hover:scale-[1.03] hover:-translate-y-1 active:scale-[0.99]
            ${isProblemIncreasing 
              ? "border-red-500/90 bg-gradient-to-br from-red-100/90 via-white to-red-100/70 dark:border-red-500/80 dark:from-red-900/60 dark:via-gray-800 dark:to-red-900/50 shadow-2xl shadow-red-400/90 dark:shadow-red-700/70" 
              : problemReviews > 10
              ? "border-orange-400/80 bg-gradient-to-br from-orange-100/80 via-white to-orange-100/60 dark:border-orange-500/70 dark:from-orange-900/50 dark:via-gray-800 dark:to-orange-900/40 shadow-2xl shadow-orange-300/80 dark:shadow-orange-700/60"
              : problemReviews > 0
              ? "border-orange-300/70 bg-white dark:border-orange-600/60 dark:bg-gray-800/70 hover:border-orange-400/80 dark:hover:border-orange-500/70 hover:shadow-xl shadow-md"
              : "border-gray-300/70 bg-white dark:border-gray-600/60 dark:bg-gray-800/70 hover:border-green-300/70 dark:hover:border-green-600/60 hover:shadow-xl shadow-md"
          }`}
          style={getCardStyle(3)}
          role="button"
          tabIndex={0}
          aria-label={`Problem Reviews: ${problemReviews} - ${isProblemIncreasing ? 'Alert Increasing' : problemReviews === 0 ? 'All Clear' : 'Review Required'}`}
        >
          {/* Premium gradient overlay */}
          <div className="absolute inset-0 bg-gradient-to-br from-white/80 via-white/30 to-transparent pointer-events-none" />
          
          {/* Refined accent bar with multiple states */}
          <div className={`absolute top-0 left-0 right-0 h-1.5 sm:h-2 transition-all duration-700 ${
            isProblemIncreasing 
              ? 'bg-gradient-to-r from-red-500 via-red-600 to-red-500 shadow-lg shadow-red-500/70' 
              : problemReviews > 10
              ? 'bg-gradient-to-r from-orange-500 via-orange-600 to-orange-500 shadow-lg shadow-orange-500/60'
              : problemReviews > 0
              ? 'bg-gradient-to-r from-orange-400 via-orange-500 to-orange-400'
              : 'bg-gradient-to-r from-gray-300 via-gray-400 to-gray-300 opacity-0 group-hover:opacity-100 group-hover:from-green-400 group-hover:via-green-500 group-hover:to-green-400'
          }`} />

          {/* Top Section - Icon + Alert Badge */}
          <div className="flex items-start justify-between mb-4 sm:mb-5 relative z-10">
            <div className={`flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 rounded-2xl transition-all duration-500 ${
              isProblemIncreasing 
                ? "bg-gradient-to-br from-red-500 via-red-600 to-red-600 shadow-xl shadow-red-400/80 dark:shadow-red-500/60 animate-shake scale-105" 
                : problemReviews > 10
                ? "bg-gradient-to-br from-orange-500 via-orange-600 to-orange-600 shadow-xl shadow-orange-400/70 dark:shadow-orange-500/50 scale-105"
                : problemReviews > 0
                ? "bg-gradient-to-br from-orange-100 to-orange-200 dark:from-orange-800/40 dark:to-orange-800/30 group-hover:scale-105 group-hover:shadow-md"
                : "bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700/40 dark:to-gray-700/30 group-hover:scale-105 group-hover:from-green-100 group-hover:to-green-200 dark:group-hover:from-green-800/40 dark:group-hover:to-green-800/30"
            }`}>
              <AlertTriangle className={`size-6 sm:size-9 transition-all duration-500 ${
                isProblemIncreasing 
                  ? "text-white drop-shadow-lg" 
                  : problemReviews > 10
                  ? "text-white drop-shadow-lg"
                  : problemReviews > 0
                  ? "text-orange-700 dark:text-orange-300"
                  : "text-gray-500 dark:text-gray-400 group-hover:text-green-700 dark:group-hover:text-green-300"
              }`} strokeWidth={2.5} />
            </div>
            <div className="flex flex-col items-end gap-1.5">
              {isProblemIncreasing && (
                <div className="flex items-center gap-1 bg-red-600/25 dark:bg-red-500/25 px-2.5 py-1 rounded-full border border-red-400/60 dark:border-red-500/50 shadow-sm animate-pulse">
                  <AlertTriangle className="size-3.5 text-red-700 dark:text-red-300" />
                  <span className="text-[10px] sm:text-xs font-bold text-red-700 dark:text-red-300 uppercase tracking-wider">
                    Alert
                  </span>
                </div>
              )}
              {!isProblemIncreasing && problemReviews > 10 && (
                <Badge color="warning">
                  <span className="text-xs sm:text-sm font-bold tracking-wide px-1">‚ö† REVIEW</span>
                </Badge>
              )}
              {!isProblemIncreasing && problemReviews > 0 && problemReviews <= 10 && (
                <Badge color="warning">
                  <span className="text-xs sm:text-sm font-semibold tracking-wide px-1">Monitor</span>
                </Badge>
              )}
              {!isProblemIncreasing && problemReviews === 0 && (
                <div className="flex items-center gap-1 bg-green-600/20 dark:bg-green-500/20 px-2.5 py-1 rounded-full border border-green-400/50 dark:border-green-500/40 shadow-sm">
                  <Sparkles className="size-3.5 text-green-700 dark:text-green-300" />
                  <span className="text-[10px] sm:text-xs font-bold text-green-700 dark:text-green-300 uppercase tracking-wider">
                    Clear
                  </span>
                </div>
              )}
            </div>
          </div>

          {/* Middle Section - Label + Value */}
          <div className="flex-1 relative z-10">
            <span className={`block text-xs sm:text-sm font-bold mb-2 sm:mb-3 uppercase tracking-wider transition-colors duration-500 ${
              isProblemIncreasing 
                ? 'text-red-700 dark:text-red-300' 
                : problemReviews > 10
                ? 'text-orange-700 dark:text-orange-300'
                : problemReviews > 0
                ? 'text-gray-600 dark:text-gray-300'
                : 'text-gray-500 dark:text-gray-400'
            }`}>
              Problem Reviews
            </span>
            <div className="flex items-baseline gap-2 mb-2">
              <h4 className={`font-black text-3xl sm:text-5xl transition-all duration-500 tabular-nums leading-none ${
                isProblemIncreasing 
                  ? 'text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-red-700 to-red-600 dark:from-red-400 dark:via-red-500 dark:to-red-400 drop-shadow-sm' 
                  : problemReviews > 10
                  ? 'text-transparent bg-clip-text bg-gradient-to-r from-orange-600 via-orange-700 to-orange-600 dark:from-orange-400 dark:via-orange-500 dark:to-orange-400 drop-shadow-sm'
                  : problemReviews > 0
                  ? 'text-gray-900 dark:text-white'
                  : 'text-gray-500 dark:text-gray-400'
              }`}>
                <AnimatedNumber value={problemReviews} decimals={0} duration={800} />
              </h4>
              {problemChange && problemReviews > 0 && <TrendSparkline change={problemChange} />}
            </div>
            <div className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
              <span className={`text-xs sm:text-sm font-semibold transition-colors duration-500 ${
                isProblemIncreasing 
                  ? 'text-red-700 dark:text-red-300' 
                  : problemReviews > 10
                  ? 'text-orange-700 dark:text-orange-300'
                  : problemReviews > 0
                  ? 'text-gray-600 dark:text-gray-300'
                  : 'text-gray-500 dark:text-gray-400'
              }`}>
                1‚òÖ + 2‚òÖ ratings
              </span>
              {isProblemIncreasing && (
                <span className="text-[9px] text-red-600/80 dark:text-red-400/80 italic hidden sm:inline font-semibold">
                  Needs attention now
                </span>
              )}
              {problemReviews === 0 && (
                <span className="text-[9px] text-green-600/70 dark:text-green-400/70 italic hidden sm:inline">
                  Perfect streak!
                </span>
              )}
            </div>
          </div>

          {/* Bottom Section - Trend */}
          {problemChange && (
            <div className="flex items-center justify-between gap-2 mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-100/80 dark:border-gray-700/50 relative z-10">
              <div className="flex items-center gap-1.5">
                <Badge color={problemChange.isNegative ? "success" : "error"}>
                  <span className="text-[10px] sm:text-xs flex items-center gap-1 font-semibold shadow-sm">
                    {problemChange.isPositive ? <ArrowUpIcon className="size-3" /> : <ArrowDownIcon className="size-3" />}
                    {problemChange.value}%
                  </span>
                </Badge>
                <span className="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400">vs last period</span>
              </div>
              <ChevronRight className="size-4 text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
            </div>
          )}
          
          {/* Hover glow effect - changes color based on state */}
          <div className={`absolute inset-0 rounded-xl sm:rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none ${
            isProblemIncreasing
              ? 'bg-gradient-to-br from-red-400/0 via-red-400/0 to-red-400/10'
              : problemReviews > 0
              ? 'bg-gradient-to-br from-orange-400/0 via-orange-400/0 to-orange-400/5'
              : 'bg-gradient-to-br from-green-400/0 via-green-400/0 to-green-400/5'
          }`} />
        </div>
      </>
    );
  }
}




